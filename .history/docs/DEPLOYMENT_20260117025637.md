# Deployment Guide

This guide covers deploying notCringe to production. We recommend **Vercel** for the easiest deployment, but also provide instructions for other platforms.

## Table of Contents

- [Quick Start (Vercel)](#quick-start-vercel)
- [Environment Variables](#environment-variables)
- [Database Setup](#database-setup)
- [Alternative Platforms](#alternative-platforms)
- [Post-Deployment](#post-deployment)
- [Monitoring](#monitoring)
- [Troubleshooting](#troubleshooting)

---

## Quick Start (Vercel)

### Prerequisites

- GitHub account
- Vercel account (free)
- PostgreSQL database (Supabase, Neon, or Railway recommended)
- OpenAI API key

### Step-by-Step

#### 1. Push to GitHub

```bash
git add .
git commit -m "Initial commit"
git push origin main
```

#### 2. Connect to Vercel

1. Go to [vercel.com](https://vercel.com)
2. Click "New Project"
3. Import your GitHub repository
4. Vercel will auto-detect Next.js

#### 3. Configure Environment Variables

In Vercel dashboard, add these environment variables:

| Variable | Value | Notes |
|----------|-------|-------|
| `DATABASE_URL` | `postgresql://...` | PostgreSQL connection string |
| `OPENAI_API_KEY` | `sk-...` | Your OpenAI API key |
| `NODE_ENV` | `production` | (Optional) Vercel sets this automatically |

#### 4. Deploy

1. Click "Deploy"
2. Wait 2-3 minutes for build
3. Visit your deployment URL

#### 5. Run Database Migrations

After first deployment:

```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Run migrations
vercel env pull .env.local
npm run db:migrate
```

Or use Vercel's dashboard to run migrations:
1. Go to "Settings" â†’ "Functions"
2. Add a migration script (see [Database Migrations](#database-migrations))

---

## Environment Variables

### Required

```bash
# Database
DATABASE_URL="postgresql://user:password@host:5432/dbname?sslmode=require"

# OpenAI
OPENAI_API_KEY="sk-proj-..."
```

### Optional

```bash
# Application
NODE_ENV="production"
NEXT_PUBLIC_APP_URL="https://your-domain.com"

# Analytics (if added)
NEXT_PUBLIC_GA_ID="G-..."
VERCEL_ANALYTICS_ID="..." # Auto-set by Vercel

# Rate Limiting (future)
UPSTASH_REDIS_URL="..."
UPSTASH_REDIS_TOKEN="..."

# Error Tracking (future)
SENTRY_DSN="..."
```

### Setting Environment Variables

#### Vercel
1. Dashboard â†’ Your Project â†’ Settings â†’ Environment Variables
2. Add variables for Production, Preview, Development

#### Vercel CLI
```bash
vercel env add DATABASE_URL production
vercel env add OPENAI_API_KEY production
```

#### Local Development
Create `.env.local`:
```bash
cp .env.example .env.local
# Edit .env.local with your values
```

---

## Database Setup

### Option 1: Supabase (Recommended)

1. Create account at [supabase.com](https://supabase.com)
2. Create new project
3. Go to Settings â†’ Database
4. Copy connection string (Transaction mode)
5. Use in `DATABASE_URL`

**Connection String Format:**
```
postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres?sslmode=require
```

### Option 2: Neon

1. Create account at [neon.tech](https://neon.tech)
2. Create new project
3. Copy connection string
4. Use in `DATABASE_URL`

### Option 3: Railway

1. Create account at [railway.app](https://railway.app)
2. New Project â†’ PostgreSQL
3. Copy connection string from Variables tab
4. Use in `DATABASE_URL`

### Option 4: Self-Hosted

Requirements:
- PostgreSQL 13 or higher
- SSL enabled (recommended)
- Accessible from deployment platform

### Database Migrations

After setting up database:

```bash
# Generate Prisma client
npx prisma generate

# Run migrations
npx prisma migrate deploy

# Verify with Prisma Studio (optional)
npx prisma studio
```

**Note:** Use `migrate deploy` in production, not `migrate dev`.

---

## Alternative Platforms

### Netlify

1. Connect GitHub repo
2. Build settings:
   - Build command: `npm run build`
   - Publish directory: `.next`
3. Add environment variables
4. Deploy

**Note:** Netlify requires additional configuration for Next.js API routes. Use Netlify Functions or switch to Vercel.

### Railway

1. New Project â†’ GitHub Repo
2. Railway auto-detects Next.js
3. Add PostgreSQL service (automatically linked)
4. Add environment variables:
   - `OPENAI_API_KEY`
5. Deploy

```bash
# Or use Railway CLI
npm i -g @railway/cli
railway login
railway init
railway up
```

### DigitalOcean App Platform

1. Create App â†’ GitHub
2. Detect Next.js automatically
3. Add Database (Managed PostgreSQL)
4. Environment Variables:
   - `DATABASE_URL` (auto-set if using managed DB)
   - `OPENAI_API_KEY`
5. Deploy

### Docker + VPS

Build and run with Docker:

```dockerfile
# Dockerfile
FROM node:20-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci

FROM node:20-alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npx prisma generate
RUN npm run build

FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV production
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
EXPOSE 3000
CMD ["node", "server.js"]
```

```bash
# Build and run
docker build -t notcringe .
docker run -p 3000:3000 \
  -e DATABASE_URL="..." \
  -e OPENAI_API_KEY="..." \
  notcringe
```

### Kubernetes

See `k8s/` directory (to be added) for Kubernetes manifests.

---

## Post-Deployment

### 1. Verify Deployment

Check these endpoints:

- **Homepage:** `https://your-domain.com`
- **API Health:** `https://your-domain.com/api/generate` (POST request)

```bash
# Test API
curl -X POST https://your-domain.com/api/generate \
  -H "Content-Type: application/json" \
  -d '{
    "postText": "Test post",
    "vibe": "diplomatic"
  }'
```

### 2. Configure Custom Domain

#### Vercel

1. Project Settings â†’ Domains
2. Add your domain
3. Update DNS:
   - Type: `CNAME`
   - Name: `@` or `www`
   - Value: `cname.vercel-dns.com`

#### Cloudflare (Optional)

For caching and DDoS protection:

1. Add site to Cloudflare
2. Point DNS to Vercel
3. Configure Page Rules:
   - Cache API responses (be careful with this)
   - Force HTTPS

### 3. Set Up Analytics

#### Vercel Analytics (Built-in)

Already included if deployed on Vercel.

#### Google Analytics

1. Create GA4 property
2. Add tracking ID to `.env`:
   ```bash
   NEXT_PUBLIC_GA_ID="G-XXXXXXXXXX"
   ```
3. Add Google Analytics component (to be implemented)

#### PostHog (Optional)

For product analytics:

```bash
npm install posthog-js
```

Add to `app/layout.tsx`:

```tsx
import posthog from 'posthog-js'

if (typeof window !== 'undefined') {
  posthog.init('YOUR_API_KEY', {
    api_host: 'https://app.posthog.com'
  })
}
```

### 4. Set Up Error Tracking

#### Sentry

```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

Add to `.env`:
```bash
SENTRY_DSN="https://...@sentry.io/..."
```

---

## Monitoring

### Application Metrics

Monitor these metrics:

| Metric | Target | Critical Threshold |
|--------|--------|-------------------|
| API Latency (P50) | < 4s | > 10s |
| API Latency (P95) | < 6s | > 15s |
| Error Rate | < 1% | > 5% |
| Uptime | > 99.5% | < 99% |

### Vercel Dashboard

- **Analytics** - Page views, visitors
- **Runtime Logs** - Function execution logs
- **Performance** - Web Vitals (LCP, FID, CLS)

### Database Monitoring

#### Supabase

- Dashboard â†’ Database â†’ Monitoring
- Watch connections, CPU, memory

#### Neon

- Dashboard â†’ Monitoring
- Query performance

### OpenAI Usage

Monitor at [platform.openai.com/usage](https://platform.openai.com/usage):

- **Daily spend**
- **Token usage**
- **Rate limits**

Set usage limits:
1. Billing â†’ Usage Limits
2. Set hard cap (e.g., $100/month)

---

## Scaling

### Vertical Scaling

Vercel handles this automatically.

### Horizontal Scaling

Vercel serverless functions scale automatically. No action needed.

### Database Scaling

#### Supabase
- Free tier: 500 MB, 2 GB bandwidth
- Pro tier: 8 GB, 50 GB bandwidth
- Auto-scales connections

#### Neon
- Free tier: 1 GB, 10 branches
- Pro tier: Auto-scales compute

#### Connection Pooling

Already configured via Prisma. If hitting connection limits:

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations
}
```

### Caching (Future)

For high traffic, add Redis:

```bash
npm install @upstash/redis
```

Cache frequently generated replies:

```typescript
import { Redis } from '@upstash/redis'

const redis = Redis.fromEnv()

// Cache key based on post text + options
const cacheKey = `reply:${hash(postText + JSON.stringify(options))}`
const cached = await redis.get(cacheKey)

if (cached) {
  return cached
}

// Generate and cache
const replies = await generateReplies(...)
await redis.setex(cacheKey, 3600, replies) // 1 hour TTL
```

---

## Security

### API Rate Limiting

Add rate limiting to prevent abuse:

```typescript
// lib/rate-limit.ts
import { Ratelimit } from "@upstash/ratelimit"
import { Redis } from "@upstash/redis"

const redis = Redis.fromEnv()

const ratelimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(20, "1 h"), // 20 requests per hour
})

export async function checkRateLimit(identifier: string) {
  const { success, limit, reset, remaining } = await ratelimit.limit(identifier)
  return { success, limit, reset, remaining }
}
```

Use in API routes:

```typescript
const ip = request.headers.get("x-forwarded-for") || "unknown"
const { success } = await checkRateLimit(ip)

if (!success) {
  return NextResponse.json(
    { error: "Rate limit exceeded" },
    { status: 429 }
  )
}
```

### Content Security Policy

Add to `next.config.ts`:

```typescript
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'Referrer-Policy',
    value: 'origin-when-cross-origin'
  }
]

export default {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ]
  },
}
```

### Environment Variables Security

- Never commit `.env` files
- Use Vercel's encrypted environment variables
- Rotate API keys regularly
- Use different keys for dev/staging/prod

---

## Troubleshooting

### Build Fails

**Error: Prisma Client not generated**

```bash
# Add to package.json scripts
{
  "postinstall": "prisma generate"
}
```

**Error: Cannot find module**

Check that all dependencies are in `dependencies`, not `devDependencies`.

### Database Connection Issues

**Error: Connection timeout**

- Check `DATABASE_URL` is correct
- Verify database allows connections from Vercel IPs (usually 0.0.0.0/0)
- Enable SSL with `?sslmode=require`

**Error: Too many connections**

Use connection pooling:

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}
```

```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    log: ['error'],
  })

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

### API Errors

**Error: OpenAI rate limit**

- Check usage at [platform.openai.com](https://platform.openai.com)
- Upgrade to higher tier
- Implement retry logic with backoff

**Error: API timeout (504)**

Vercel function timeout:
- Free tier: 10s
- Pro tier: 60s

Optimize:
- Reduce prompt size
- Use faster model (gpt-4o-mini)
- Implement streaming

### Performance Issues

**Slow cold starts**

- Next.js 16 reduces this significantly
- Ensure Prisma client is generated in build
- Use Edge Runtime (future consideration)

**High latency**

- Check OpenAI API latency
- Enable Vercel Analytics to identify bottlenecks
- Add logging to measure each step

---

## Rollback

If deployment has issues:

### Vercel

1. Go to Deployments
2. Find previous working deployment
3. Click "..." â†’ "Promote to Production"

### Database Rollback

```bash
# Roll back last migration
npx prisma migrate resolve --rolled-back <migration-name>
```

---

## Backup and Recovery

### Database Backups

#### Automated (Supabase/Neon)

Automatic daily backups included.

#### Manual Backup

```bash
# Using pg_dump
pg_dump -Fc $DATABASE_URL > backup.dump

# Restore
pg_restore -d $DATABASE_URL backup.dump
```

### Code Backups

- GitHub serves as primary backup
- Create tags for releases:

```bash
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0
```

---

## Checklist

Before going live:

- [ ] Environment variables set
- [ ] Database migrations run
- [ ] API endpoint tested
- [ ] Custom domain configured
- [ ] HTTPS enabled (automatic on Vercel)
- [ ] Analytics installed
- [ ] Error tracking configured
- [ ] Rate limiting enabled (for production)
- [ ] OpenAI spend limit set
- [ ] Database backups verified
- [ ] Monitoring set up
- [ ] Documentation updated

---

## Support

If you encounter issues:

1. Check [troubleshooting section](#troubleshooting)
2. Review Vercel logs
3. Check OpenAI status page
4. Open GitHub issue with:
   - Error message
   - Steps to reproduce
   - Environment (Vercel/other)
   - Screenshots

---

## Next Steps

After successful deployment:

1. **Monitor performance** - First week is critical
2. **Gather user feedback** - Watch for errors in Sentry
3. **Optimize costs** - Review OpenAI usage
4. **Scale as needed** - Upgrade database/Vercel plan if necessary
5. **Iterate** - Ship improvements based on feedback

Congratulations on deploying notCringe! ðŸš€
